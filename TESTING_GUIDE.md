# 图宝 - 图片生成功能测试指南

## 🎯 测试目标

验证从大纲生成到图片生成的完整流程，包括：
- ✅ 图片生成服务
- ✅ SSE实时进度推送
- ✅ 前端进度显示和图片预览
- ✅ 并发生成机制

## 📋 测试前准备

### 1. 确保后端服务运行

```bash
cd backend
python app.py
```

后端应该在 `http://localhost:5030` 运行。

### 2. 确保前端服务运行

```bash
cd frontend
npm run dev
```

前端应该在 `http://localhost:5173` 运行。

### 3. 检查环境配置

确保 `backend/.env` 文件中配置了：
```env
GEMINI_API_KEY=your-key-here
```

## 🧪 测试步骤

### 阶段1：生成大纲

1. 打开浏览器访问 `http://localhost:5173`
2. 在首页输入框输入测试主题：
   ```
   如何提高工作效率的10个小技巧
   ```
3. 点击"生成大纲"按钮
4. 等待大纲生成完成（约3-5秒）

**预期结果：**
- ✅ 显示生成中的加载状态
- ✅ 成功生成6-9页的内容大纲
- ✅ 每页包含标题和描述
- ✅ 出现"开始生成图片"按钮

### 阶段2：生成图片

1. 在大纲页面点击"开始生成图片"按钮
2. 观察进度条和状态信息

**预期结果：**
- ✅ 进度条开始更新（0% → 100%）
- ✅ 显示当前生成进度："正在生成第 X/Y 页..."
- ✅ 已生成的图片实时出现在页面上
- ✅ 每张图片显示占位图（Mock模式）
- ✅ 所有图片生成完成后显示"图片生成完成！"

### 阶段3：验证SSE推送

打开浏览器开发者工具（F12）：

1. 切换到 **Network** 标签
2. 找到 `progress/task_XXXXX` 的请求
3. 查看 **EventStream** 类型的连接

**预期结果：**
- ✅ SSE连接成功建立
- ✅ 持续接收进度更新事件
- ✅ 每个事件包含：task_id, status, progress, images等数据
- ✅ 完成时收到 `done: true` 事件

### 阶段4：查看完成结果

**预期结果：**
- ✅ 显示所有生成的图片（网格布局）
- ✅ 每张图片显示页码标签
- ✅ 提供下载链接
- ✅ "返回首页"和"下载全部"按钮可用

## 🔍 详细测试用例

### 测试用例1：基础生成流程

**步骤：**
1. 生成3页的简单大纲
2. 开始图片生成
3. 观察完整流程

**验证点：**
- [ ] 大纲生成成功
- [ ] 图片生成启动成功
- [ ] 进度实时更新
- [ ] 3张图片全部生成
- [ ] 最终状态为"完成"

### 测试用例2：多页面并发

**步骤：**
1. 生成8页的大纲
2. 开始图片生成
3. 观察并发生成过程

**验证点：**
- [ ] 8张图片并发生成
- [ ] 进度顺序更新
- [ ] 所有图片都成功生成
- [ ] 无错误和超时

### 测试用例3：错误处理

**步骤：**
1. 在没有大纲的情况下访问生成器页面

**验证点：**
- [ ] 显示"请先生成大纲"提示
- [ ] 提供"前往首页"按钮
- [ ] 不崩溃

### 测试用例4：进度数据验证

在浏览器控制台查看SSE数据：

**验证点：**
- [ ] `progress` 从0递增到100
- [ ] `completed_pages` 逐步增加
- [ ] `images` 数组逐步填充
- [ ] `status` 从 pending → running → completed
- [ ] `message` 显示当前状态

## 📊 性能测试

### 并发性能

**测试场景：** 生成8页内容

**预期指标：**
- 总耗时：< 5秒（Mock模式）
- 并发数：最多25个worker
- 内存使用：稳定，无泄漏
- CPU使用：合理范围内

### SSE连接稳定性

**测试场景：** 长时间保持SSE连接

**预期指标：**
- 连接保持稳定
- 无断开重连
- 事件推送及时
- 连接正常关闭

## 🐛 常见问题排查

### 问题1：SSE连接失败

**症状：** 进度不更新，控制台显示连接错误

**排查：**
```bash
# 检查后端是否运行
curl http://localhost:5030/health

# 检查CORS配置
# 查看backend/app.py中的CORS设置
```

### 问题2：图片不显示

**症状：** 进度更新但图片不显示

**排查：**
1. 检查浏览器控制台的图片URL
2. 确认Mock生成器返回的placeholder URL可访问
3. 检查网络请求是否成功

### 问题3：进度卡住不动

**症状：** 进度停在某个百分比

**排查：**
```bash
# 查看后端日志
cd backend
python app.py

# 检查是否有异常输出
```

## ✅ 测试检查清单

### 后端功能
- [ ] ProgressService 正确管理任务状态
- [ ] ImageService 并发生成图片
- [ ] SSE端点正确推送进度
- [ ] API路由正常响应

### 前端功能
- [ ] 大纲正确显示
- [ ] "开始生成"按钮工作
- [ ] 进度条平滑更新
- [ ] 图片实时显示
- [ ] 完成状态正确展示
- [ ] 错误处理友好

### 集成测试
- [ ] 前后端通信正常
- [ ] SSE连接稳定
- [ ] 数据流转正确
- [ ] 用户体验流畅

## 🎉 测试完成标准

当以下所有项都通过时，测试完成：

✅ 能够生成大纲
✅ 能够启动图片生成
✅ 进度实时更新且准确
✅ 所有图片正确生成和显示
✅ SSE连接稳定无错误
✅ 完成状态正确显示
✅ 错误情况有友好提示
✅ 无明显性能问题

## 📝 测试报告模板

```
测试日期：2025-XX-XX
测试人员：XXX
浏览器：Chrome/Firefox/Safari XXX

【基础功能】
- 大纲生成：✅/❌
- 图片生成：✅/❌
- 进度显示：✅/❌
- SSE推送：✅/❌

【性能表现】
- 8页生成耗时：XX秒
- 并发稳定性：✅/❌
- 内存使用：正常/异常

【问题记录】
1. XXX
2. XXX

【总体评价】
通过/不通过
```

---

**祝测试顺利！** 🐱✨