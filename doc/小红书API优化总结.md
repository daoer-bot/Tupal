# å°çº¢ä¹¦ API é›†æˆä¼˜åŒ–æ€»ç»“

## ğŸ“‹ ä¼˜åŒ–æ¦‚è¿°

åŸºäº `xhs_mcp_agent` æ¶æ„æ–‡æ¡£ï¼Œå¯¹ç°æœ‰çš„å°çº¢ä¹¦ API é›†æˆæ–¹æ¡ˆè¿›è¡Œäº†å…¨é¢é‡æ„å’Œä¼˜åŒ–ã€‚

## ğŸ¯ ä¼˜åŒ–ç›®æ ‡

1. âœ… é‡‡ç”¨æ›´æˆç†Ÿçš„æ¶æ„è®¾è®¡
2. âœ… å®ç°å®Œå–„çš„å®¢æˆ·ç«¯ç”Ÿå‘½å‘¨æœŸç®¡ç†
3. âœ… æ·»åŠ è¯·æ±‚é¢‘ç‡æ§åˆ¶å’Œé‡è¯•æœºåˆ¶
4. âœ… å®Œå–„é”™è¯¯å¤„ç†å’Œå¼‚å¸¸ç®¡ç†
5. âœ… æ”¯æŒæ‰¹é‡æ“ä½œ
6. âœ… æä¾›æ›´å¥½çš„å¯ç»´æŠ¤æ€§å’Œæ‰©å±•æ€§

## ğŸ—ï¸ æ–°æ¶æ„è®¾è®¡

### æ¶æ„å±‚æ¬¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Flask è·¯ç”±å±‚                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚  â”‚ xiaohongshu  â”‚           â”‚ xiaohongshu  â”‚            â”‚
â”‚  â”‚ (æ—§ç‰ˆ v1)    â”‚           â”‚ _v2 (æ–°ç‰ˆ)   â”‚            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜           â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚                          â”‚
          â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
          â””â”€â”€â”€â”€â”¤ ClientManagerâ”‚â”€â”€â”€â”€â”€â”€â”˜
               â”‚  (ç®¡ç†å±‚)     â”‚
               â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚                       â”‚
    â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”
    â”‚ ApiClient â”‚         â”‚  XhsClient â”‚
    â”‚ (å¼‚æ­¥åŒ…è£…) â”‚         â”‚  (æ ¸å¿ƒSDK) â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  å°çº¢ä¹¦ Web API        â”‚
                    â”‚  - edith.xiaohongshu   â”‚
                    â”‚  - creator.xiaohongshu â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ ¸å¿ƒç»„ä»¶

#### 1. ClientManager (å®¢æˆ·ç«¯ç®¡ç†å™¨)
**æ–‡ä»¶**: `backend/xhs/client_manager.py`

**åŠŸèƒ½**:
- å•ä¾‹æ¨¡å¼ç®¡ç†æ‰€æœ‰å®¢æˆ·ç«¯å®ä¾‹
- è‡ªåŠ¨æ¸…ç†è¶…æ—¶æœªä½¿ç”¨çš„å®¢æˆ·ç«¯ï¼ˆ2å°æ—¶ï¼‰
- çº¿ç¨‹å®‰å…¨çš„å¹¶å‘è®¿é—®æ§åˆ¶
- å®¢æˆ·ç«¯ç»Ÿè®¡ä¿¡æ¯è¿½è¸ª

**å…³é”®ç‰¹æ€§**:
```python
- åˆ›å»ºå®¢æˆ·ç«¯: create_client(config)
- è·å–å®¢æˆ·ç«¯: get_client(client_id)
- åˆ é™¤å®¢æˆ·ç«¯: delete_client(client_id)
- é€Ÿç‡é™åˆ¶: wait_for_rate_limit(client_id)
- ç»Ÿè®¡ä¿¡æ¯: get_client_stats(client_id)
```

#### 2. ApiClient (å¼‚æ­¥åŒ…è£…å±‚)
**æ–‡ä»¶**: `backend/xhs/async_api_client.py`

**åŠŸèƒ½**:
- å°†åŒæ­¥çš„ XhsClient åŒ…è£…æˆå¼‚æ­¥æ¥å£
- å†…ç½®é‡è¯•æœºåˆ¶ï¼ˆæœ€å¤š3æ¬¡ï¼ŒæŒ‡æ•°é€€é¿ï¼‰
- è‡ªåŠ¨é€Ÿç‡é™åˆ¶
- ç»Ÿä¸€çš„é”™è¯¯å¤„ç†

**é‡è¯•ç­–ç•¥**:
- å¯é‡è¯•å¼‚å¸¸: `DataFetchError`, `SignError`
- ä¸å¯é‡è¯•å¼‚å¸¸: `NeedVerifyError`, `IPBlockError`
- é‡è¯•å»¶è¿Ÿ: 1ç§’ * 2^attemptï¼ˆæŒ‡æ•°é€€é¿ï¼‰

#### 3. Types (ç±»å‹å®šä¹‰)
**æ–‡ä»¶**: `backend/xhs/types.py`

**åŠŸèƒ½**:
- ç»Ÿä¸€çš„è¯·æ±‚/å“åº”ç±»å‹å®šä¹‰
- æ•°æ®éªŒè¯å’Œè½¬æ¢
- ç±»å‹å®‰å…¨ä¿è¯

**ä¸»è¦ç±»å‹**:
- `CreateClientRequest`: å®¢æˆ·ç«¯åˆ›å»ºè¯·æ±‚
- `NoteRequest`: ç¬”è®°è¯·æ±‚
- `SearchNotesRequest`: æœç´¢ç¬”è®°è¯·æ±‚
- `BatchNotesRequest`: æ‰¹é‡ç¬”è®°è¯·æ±‚
- `NoteResponse`: ç¬”è®°å“åº”
- `SearchResponse`: æœç´¢å“åº”

#### 4. Flask è·¯ç”± v2
**æ–‡ä»¶**: `backend/api/routes/xiaohongshu_v2.py`

**åŠŸèƒ½**:
- åŸºäºæ–°æ¶æ„çš„ REST API æ¥å£
- æ”¯æŒä¸¤ç§ä½¿ç”¨æ¨¡å¼ï¼š
  1. æä¾› cookie åˆ›å»ºä¸´æ—¶å®¢æˆ·ç«¯
  2. æä¾› client_id å¤ç”¨ç°æœ‰å®¢æˆ·ç«¯
- å®Œå–„çš„é”™è¯¯å¤„ç†å’ŒçŠ¶æ€ç 

## ğŸš€ æ–°å¢åŠŸèƒ½

### 1. æ‰¹é‡æ“ä½œæ”¯æŒ

**æ¥å£**: `POST /api/xiaohongshu/v2/note/batch`

**åŠŸèƒ½**:
- æ‰¹é‡è·å–å¤šä¸ªç¬”è®°è¯¦æƒ…
- è‡ªåŠ¨å¤„ç†å¤±è´¥é¡¹
- å¯é…ç½®æ‰¹é‡å»¶è¿Ÿ

**ç¤ºä¾‹**:
```json
{
  "cookie": "xxx",
  "notes": [
    {"note_id": "note1"},
    {"note_id": "note2"}
  ],
  "batch_delay": 0.5
}
```

**å“åº”**:
```json
{
  "success": true,
  "data": {
    "success_count": 1,
    "error_count": 1,
    "results": [...],
    "errors": [...]
  }
}
```

### 2. è¯·æ±‚é¢‘ç‡æ§åˆ¶

**å®ç°ä½ç½®**: `ClientManager.wait_for_rate_limit()`

**åŠŸèƒ½**:
- æ¯ä¸ªå®¢æˆ·ç«¯ç‹¬ç«‹çš„é€Ÿç‡é™åˆ¶
- é»˜è®¤ 1 ç§’/è¯·æ±‚ï¼Œå¯é…ç½®
- è‡ªåŠ¨ç­‰å¾…åˆ°å…è®¸æ—¶é—´

**é…ç½®**:
```python
CreateClientRequest(
    cookie="xxx",
    rate_limit=1.0  # ç§’
)
```

### 3. è‡ªåŠ¨é‡è¯•æœºåˆ¶

**å®ç°ä½ç½®**: `ApiClient._execute_with_retry()`

**åŠŸèƒ½**:
- æœ€å¤šé‡è¯• 3 æ¬¡ï¼ˆå¯é…ç½®ï¼‰
- æŒ‡æ•°é€€é¿ç­–ç•¥
- æ™ºèƒ½å¼‚å¸¸åˆ†ç±»

**é‡è¯•é€»è¾‘**:
```python
for attempt in range(max_retries):
    try:
        return await func()
    except (DataFetchError, SignError):
        if attempt == max_retries - 1:
            raise
        await asyncio.sleep(retry_delay * (2 ** attempt))
```

### 4. å®Œå–„çš„é”™è¯¯å¤„ç†

**é”™è¯¯åˆ†ç±»**:
- `NeedVerifyError` (403): éœ€è¦éªŒè¯ç 
- `IPBlockError` (403): IP è¢«å°
- `SignError` (403): ç­¾åé”™è¯¯
- `DataFetchError` (500): æ•°æ®è·å–å¤±è´¥

**é”™è¯¯å“åº”**:
```json
{
  "success": false,
  "error": "éœ€è¦éªŒè¯ç : ...",
  "code": 403
}
```

### 5. å®¢æˆ·ç«¯ç»Ÿè®¡ä¿¡æ¯

**æ¥å£**: `GET /api/xiaohongshu/v2/client/<client_id>/stats`

**è¿”å›ä¿¡æ¯**:
```json
{
  "client_id": "xhs_client_1",
  "created_at": "2024-01-01T00:00:00",
  "last_used": "2024-01-01T00:10:00",
  "uptime_seconds": 600,
  "request_count": 100,
  "error_count": 5,
  "error_rate": 0.05,
  "config": {
    "timeout": 10,
    "max_retries": 3,
    "rate_limit": 1.0
  }
}
```

## ğŸ“ API å¯¹æ¯”

### æ—§ç‰ˆ API (v1)

**åˆ›å»ºå®¢æˆ·ç«¯**:
```http
POST /api/xiaohongshu/client
{
  "cookie": "xxx"
}
```

**è·å–ç¬”è®°**:
```http
POST /api/xiaohongshu/note
{
  "client_id": "xhs_client_1",
  "note_id": "xxx"
}
```

### æ–°ç‰ˆ API (v2)

**åˆ›å»ºå®¢æˆ·ç«¯ï¼ˆå¢å¼ºï¼‰**:
```http
POST /api/xiaohongshu/v2/client
{
  "cookie": "xxx",
  "max_retries": 3,
  "retry_delay": 1.0,
  "rate_limit": 1.0
}
```

**è·å–ç¬”è®°ï¼ˆçµæ´»ï¼‰**:
```http
POST /api/xiaohongshu/v2/note
{
  "cookie": "xxx",  // æˆ– "client_id": "xxx"
  "note_id": "xxx"
}
```

**æ‰¹é‡è·å–ç¬”è®°ï¼ˆæ–°å¢ï¼‰**:
```http
POST /api/xiaohongshu/v2/note/batch
{
  "cookie": "xxx",
  "notes": [
    {"note_id": "note1"},
    {"note_id": "note2"}
  ]
}
```

## ğŸ”§ ä½¿ç”¨æŒ‡å—

### æ–¹å¼ 1: ä¸´æ—¶å®¢æˆ·ç«¯ï¼ˆæ¨èç”¨äºå•æ¬¡è¯·æ±‚ï¼‰

```python
import requests

response = requests.post(
    'http://localhost:5030/api/xiaohongshu/v2/note',
    json={
        'cookie': 'your_cookie',
        'note_id': 'note_id'
    }
)
```

### æ–¹å¼ 2: æŒä¹…å®¢æˆ·ç«¯ï¼ˆæ¨èç”¨äºå¤šæ¬¡è¯·æ±‚ï¼‰

```python
import requests

# 1. åˆ›å»ºå®¢æˆ·ç«¯
response = requests.post(
    'http://localhost:5030/api/xiaohongshu/v2/client',
    json={
        'cookie': 'your_cookie',
        'rate_limit': 1.0
    }
)
client_id = response.json()['data']['client_id']

# 2. ä½¿ç”¨å®¢æˆ·ç«¯
response = requests.post(
    'http://localhost:5030/api/xiaohongshu/v2/note',
    json={
        'client_id': client_id,
        'note_id': 'note_id'
    }
)

# 3. æŸ¥çœ‹ç»Ÿè®¡
response = requests.get(
    f'http://localhost:5030/api/xiaohongshu/v2/client/{client_id}/stats'
)

# 4. åˆ é™¤å®¢æˆ·ç«¯
requests.delete(
    f'http://localhost:5030/api/xiaohongshu/v2/client/{client_id}'
)
```

### æ–¹å¼ 3: æ‰¹é‡æ“ä½œ

```python
import requests

response = requests.post(
    'http://localhost:5030/api/xiaohongshu/v2/note/batch',
    json={
        'cookie': 'your_cookie',
        'notes': [
            {'note_id': 'note1'},
            {'note_id': 'note2'},
            {'note_id': 'note3'}
        ],
        'batch_delay': 0.5
    }
)

result = response.json()['data']
print(f"æˆåŠŸ: {result['success_count']}, å¤±è´¥: {result['error_count']}")
```

## ğŸ“Š æ€§èƒ½ä¼˜åŒ–

### 1. è¿æ¥å¤ç”¨
- ä½¿ç”¨ `requests.Session` ç»´æŠ¤è¿æ¥æ± 
- å‡å°‘ TCP æ¡æ‰‹å¼€é”€

### 2. é€Ÿç‡é™åˆ¶
- é¿å…è§¦å‘å°çº¢ä¹¦åçˆ¬æœºåˆ¶
- å¯é…ç½®çš„è¯·æ±‚é—´éš”

### 3. è‡ªåŠ¨é‡è¯•
- ä¸´æ—¶æ€§é”™è¯¯è‡ªåŠ¨é‡è¯•
- æŒ‡æ•°é€€é¿é¿å…æœåŠ¡å™¨å‹åŠ›

### 4. å®¢æˆ·ç«¯ç®¡ç†
- è‡ªåŠ¨æ¸…ç†è¿‡æœŸå®¢æˆ·ç«¯
- å‡å°‘å†…å­˜å ç”¨

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. Cookie ç®¡ç†
- Cookie é€šå¸¸ 7-30 å¤©è¿‡æœŸ
- å»ºè®®å®šæœŸæ£€æŸ¥å’Œæ›´æ–°
- ä¸è¦åœ¨ä»£ç ä¸­ç¡¬ç¼–ç  Cookie

### 2. è¯·æ±‚é¢‘ç‡
- é»˜è®¤ 1 ç§’/è¯·æ±‚
- è¿‡å¿«å¯èƒ½è§¦å‘éªŒè¯ç æˆ– IP å°ç¦
- å»ºè®®æ ¹æ®å®é™…æƒ…å†µè°ƒæ•´

### 3. é”™è¯¯å¤„ç†
- é‡åˆ°éªŒè¯ç åº”åœæ­¢è¯·æ±‚
- IP è¢«å°éœ€è¦æ›´æ¢ä»£ç†æˆ–ç­‰å¾…
- ç­¾åé”™è¯¯æ£€æŸ¥ Cookie æ˜¯å¦æœ‰æ•ˆ

### 4. æ‰¹é‡æ“ä½œ
- å»ºè®®æ¯æ‰¹ä¸è¶…è¿‡ 10 ä¸ª
- é€‚å½“å¢åŠ æ‰¹é‡å»¶è¿Ÿ
- ç›‘æ§é”™è¯¯ç‡

## ğŸ”„ è¿ç§»æŒ‡å—

### ä» v1 è¿ç§»åˆ° v2

**æ­¥éª¤ 1**: æ›´æ–° API ç«¯ç‚¹
```python
# æ—§ç‰ˆ
url = '/api/xiaohongshu/note'

# æ–°ç‰ˆ
url = '/api/xiaohongshu/v2/note'
```

**æ­¥éª¤ 2**: è°ƒæ•´è¯·æ±‚å‚æ•°
```python
# æ—§ç‰ˆ - å¿…é¡»å…ˆåˆ›å»ºå®¢æˆ·ç«¯
client_id = create_client(cookie)
get_note(client_id, note_id)

# æ–°ç‰ˆ - å¯ä»¥ç›´æ¥ä½¿ç”¨ cookie
get_note(cookie=cookie, note_id=note_id)
```

**æ­¥éª¤ 3**: å¤„ç†æ–°çš„é”™è¯¯å“åº”
```python
response = requests.post(url, json=data)
if not response.json()['success']:
    error = response.json()['error']
    # æ ¹æ®é”™è¯¯ç±»å‹å¤„ç†
```

## ğŸ“ˆ æœªæ¥ä¼˜åŒ–æ–¹å‘

### 1. Cookie æŒä¹…åŒ–ç®¡ç†
- å®ç° Cookie å­˜å‚¨å’Œè‡ªåŠ¨åˆ·æ–°
- æ”¯æŒå¤šè´¦å·ç®¡ç†

### 2. ç¼“å­˜æœºåˆ¶
- æ·»åŠ è¯·æ±‚ç»“æœç¼“å­˜
- å‡å°‘é‡å¤è¯·æ±‚

### 3. ç›‘æ§å’Œå‘Šè­¦
- è¯·æ±‚æˆåŠŸç‡ç›‘æ§
- å¼‚å¸¸æƒ…å†µå‘Šè­¦

### 4. æ€§èƒ½ä¼˜åŒ–
- è¿æ¥æ± ä¼˜åŒ–
- å¼‚æ­¥å¹¶å‘ä¼˜åŒ–

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [å°çº¢ä¹¦APIé›†æˆæ–‡æ¡£](./å°çº¢ä¹¦APIé›†æˆæ–‡æ¡£.md)
- [åç«¯æ¶æ„è¯´æ˜](./åç«¯æ¶æ„è¯´æ˜.md)

## ğŸ‰ æ€»ç»“

é€šè¿‡æœ¬æ¬¡ä¼˜åŒ–ï¼Œå°çº¢ä¹¦ API é›†æˆæ–¹æ¡ˆåœ¨ä»¥ä¸‹æ–¹é¢å¾—åˆ°äº†æ˜¾è‘—æå‡ï¼š

1. **æ¶æ„æ›´æ¸…æ™°**: é‡‡ç”¨åˆ†å±‚è®¾è®¡ï¼ŒèŒè´£æ˜ç¡®
2. **åŠŸèƒ½æ›´å®Œå–„**: æ”¯æŒæ‰¹é‡æ“ä½œã€é‡è¯•æœºåˆ¶ã€é€Ÿç‡é™åˆ¶
3. **é”™è¯¯å¤„ç†æ›´å¥å£®**: ç»†ç²’åº¦çš„å¼‚å¸¸åˆ†ç±»å’Œå¤„ç†
4. **å¯ç»´æŠ¤æ€§æ›´å¥½**: ç±»å‹å®šä¹‰æ¸…æ™°ï¼Œä»£ç ç»“æ„åˆç†
5. **æ‰©å±•æ€§æ›´å¼º**: æ˜“äºæ·»åŠ æ–°åŠŸèƒ½å’Œä¼˜åŒ–

æ–°ç‰ˆ API (v2) ä¸æ—§ç‰ˆ (v1) å¹¶å­˜ï¼Œå¯ä»¥å¹³æ»‘è¿ç§»ï¼Œä¸å½±å“ç°æœ‰åŠŸèƒ½ã€‚